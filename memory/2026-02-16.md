# 2026-02-16 ‚Äî Bracket Optimization Session

## V1 Bracket Optimization (Complete)

### Phase 1: SL Sweep (TP=80)
- Swept SL 1-20, then 5-15 fine-grained
- **Winner: SL 10** ‚Äî PF 1.17 (after 0.52pt commission), +527.8 pts net, 13.4% WR
- Fractional SL (0.25 increments) confirmed: no difference within integer bands ‚Äî NOT a bug, MNQ 5m candle lows don't resolve that finely

### Phase 2: TP Sweep (SL=10)
- Swept TP 40-150 in steps of 5
- **Winner: TP 80** ‚Äî PF 1.17 after commission, +527.8 pts net
- TP 75 second best (1.12), everything above 85 drops fast

### Phase 3: Trail/BE Sweep (SL=10, TP=80)
- Added `customTrailTrigger`, `customTrailDistance`, `customAutoBreakEven` to BacktestOpts and engine
- **Auto-breakeven**: Zero effect at any trigger level (BE logic doesn't modify stop mid-trade in backtest path)
- **Trailing stop**: Trail trigger 50 / distance 5 showed best raw numbers (PF 1.25 after comm, +774 pts)
- **BUT**: Fabian caught that trail on 5m OHLC data is unreliable ‚Äî engine assumes favorable price order within candle. Tight 5pt trail especially suspect.
- **Conclusion**: Trail results are optimistic/unreliable. Baseline SL 10 / TP 80 without trail (PF 1.17) is the honest number.

### Approved Dev Items (all 7 approved by Fabian)
Build order: #5/#6 first, then #1/#3, then #2/#4/#7
1. Unlock command bridge for bracket R&D
2. Fix fractional SL sweep semantics (confirmed: not actually broken, just MNQ resolution)
3. Add trail/BE params to public backtest path (done in engine)
4. Enforce preset consistency
5. Fix exit-order semantics for trailing
6. Add intrabar/tick-aware trail trigger mode
7. Fix Entry Designer discoverability

### Final Optimized V1 Bracket (SUPERSEDED ‚Äî see Quarter-Step update below)
```
SL: 10 | TP: 80 | No trail (unreliable on 5m) | No auto-BE (not functional)
Net PF: 1.17 | Net PnL: +527.8 pts (2yr) | WR: 13.4% | 359 trades
Commission: 0.52 pts/trade
```

---

## Quarter-Step Optimization (2026-02-15, same session continued)

Gorka enabled 0.25-step resolution in the backtester. Re-swept everything.

### Phase 1b: SL Quarter-Step Sweep (TP=80)
- Swept SL 5.00‚Äì15.00 in 0.25 steps (41 values)
- **Winner: SL 10.25** ‚Äî Raw PF 1.26, +817.25 pts, 13.9% WR
- After commission: Net PF 1.20, +630.57 pts
- Clear peak ‚Äî SL 10.00 was +527.82 net, so 10.25 adds +102.75 pts

### Phase 2b: TP Quarter-Step Sweep (SL=10.25)
- Swept TP 60.00‚Äì100.00 in 0.25 steps (161 values)
- **Winner: TP 82.25** ‚Äî Raw PF 1.28, +871.25 pts, 13.9% WR
- After commission: Net PF 1.22, +684.57 pts
- Plateau from 80‚Äì84.25 all strong, but 82.25 is the absolute peak

### Phase 3b: Auto-Breakeven Sweep (SL=10.25, TP=82.25)
- Swept BE trigger 5‚Äì70 in 2.5 steps
- **No BE setting beats baseline PF** (1.22)
- Tight BE (5-15) dramatically cuts MaxDD (439‚Äì499 vs 867) but costs ~250 pts PnL
- **Fabian's key insight**: Tight BE results are unreliable on 5m data ‚Äî engine assumes favorable candle order, so BE triggers that should be SL hits get scored as scratches instead
- Valley at BE 25-30 (PF 1.03-1.05) then recovery at 35+ is suspicious pattern
- **Decision: No auto-BE until tick data available**

### Phase 3b: Trailing Stop
- **Deferred** ‚Äî same intra-candle assumption problem as auto-BE
- Need tick data or 1m candles to trust trailing stop results

### Window Filter Bug Fix
- Forced exit at 4:15 ET was dead code ‚Äî window filter blocked all candles past 4:00 ET
- Fix: allow candles past window end when an open position exists (for SL/TP/time exit)
- Skip state machine updates (no new setups) outside window, only process exits
- This recovered ~8 TIME exit trades that were being silently dropped as PENDING
- Overall PF jumped from 1.22 ‚Üí 1.26 after fix

### Reverse Rule Investigation
- Reverse ON flips 66 LONG trades to SHORT when MNQ SD > 1.93 at entry (18% of all trades!)
- Tested 3 modes: ON (flip), OFF (take LONG), SKIP (no trade)
- Results after commission:
  - ON: 367 trades, PF 1.25, PnL +826, DD 780
  - OFF: 367 trades, PF 1.26, PnL +857, DD 506 ‚Üê WINNER
  - SKIP: 299 trades, PF 1.27, PnL +739, DD 616
- Trend LONGs past 1.93œÉ are net positive ‚Äî flipping them to SHORT destroyed edge
- Fabian approved: reverse OFF locked in

### ‚úÖ FINAL V1 BRACKET (Fabian-approved, updated)
```
SL: 10.25 | TP: 82.25 | Reverse: OFF | No trail | No auto-BE
Net PF: 1.26 | Net PnL: +856.66 pts (2yr) | WR: 15.3% | 367 trades
MaxDD: 506.5 | Commission: 0.52 pts/trade
```
**Improvement over original SL10/TP80:** +329 pts net PnL, PF from 1.17 ‚Üí 1.26

### Pending: Tick Data
- Auto-BE and trailing stop optimization blocked until tick-level or 1m candle resolution
- Fabian: "ride or die" ‚Äî let trades hit SL or TP, no mid-trade management for now

### Key Technical Notes
- Backtest CLI defaults to `FABIAN_V1_BASE` preset (includes trail 80/55, but trail=80 with TP=80 means trail never activates ‚Äî TP hits first)
- Engine file: `/Users/gorkolas/www/mercurius/scripts/alerts/backtest-engine.ts`
- Sweep scripts in mercurius root: `sweep_sl_fine.sh`, `sweep_tp.sh`, `sweep_be.sh`, `sweep_sl_quarter.sh`, `sweep_sl_quarter_wide.sh`, `sweep_tp_quarter.sh`
- Kim was in chat ‚Äî said "Ready to plunder! Arrrr!" üè¥‚Äç‚ò†Ô∏è

---

## Session 2: Window Fix, Reverse Lock-in, Tick Data Planning

### Window Filter Bug Fix (DEPLOYED)
- `forcedExitEt = 16.25` (4:15 PM) was dead code ‚Äî `windowEndEt = 16.0` caused `continue` on all candles past 4:00 PM
- Fix: allow candles past window end when open position exists (exit processing only)
- Added `if (outsideWindow) continue;` before `updateState()` to prevent new setups after 4:00 PM
- Recovered ~8 TIME exit trades previously dropped as PENDING with 0 PnL
- File: `backtest-engine.ts` ‚Äî outsideWindow gate around state machine

### Reverse Rule: 3-Mode Comparison
- Added `reverseMode` to state machine: `'reverse'` (flip), `'skip'` (no trade), `'off'` (take LONG)
- State machine in `phases.ts` ‚Äî `handleEntryReady` function
- Worker `index.ts` updated to parse `reverse=skip` URL param
- Results (SL 10.25, TP 82.25, after commission):
  - **ON (flip):** 367 trades, PF 1.25, Net PnL +826, MaxDD 780
  - **OFF (take LONG):** 367 trades, PF 1.26, Net PnL +857, MaxDD 506.5 ‚Üê WINNER
  - **SKIP (no trade):** 299 trades, PF 1.27, Net PnL +739, MaxDD 615.5
- **Fabian locked in: reverse OFF** ‚Äî trend LONGs past 1.93œÉ are net positive

### Dirty Wick Filter (re-confirmed with fixed engine)
- With filter: 367 trades, PF 1.33 raw, PnL +1047.5, DD 506.5
- Without: 369 trades, PF 1.32 raw, PnL +1027, DD 516.75
- Blocked dates: 2024-08-14 (SHORT SL) and 2026-02-10 (LONG SL) ‚Äî both losers
- Keeps ~21.5 pts. Filter stays.

### Half Days Analysis
- 6 half-day trades in 2 years: 5 SL losses + 1 TIME win (2025-12-24 +64.5)
- Net impact: ~+10 pts after commission ‚Äî negligible either way
- Not worth excluding

### Tick Data Plan
- Need MNQ tick-by-tick trade prices for trailing stop / auto-BE optimization
- 1m candles insufficient for tight trails (5-10 pts) ‚Äî same intra-candle ambiguity
- Fabian can export from NinjaTrader (free, tested 1 day export)
- Databento has tick data but pricing unclear ‚Äî Gorka already has account for OHLC
- Portara/CQG also an option (~$520 for 2yr MNQ)
- Architecture plan: store daily tick files in R2, only load days with open trades during backtest
- Pre-process to binary format for speed: `[timestamp_u32, price_u32]` pairs

### Trade Execution Pipeline
- Already wired: user says "long/short/close" ‚Üí Saucey relays `TRADE:` to Hermes via `sessions_send` ‚Üí Hermes executes on Tradovate/Apex
- Fabian asked how to fire trades ‚Äî confirmed pipeline is ready, just needs a "test" command to verify
- Auto-execution from alerts not yet connected (alerts ‚Üí Telegram ‚Üí human decides ‚Üí manual command)

---

## Worker Defaults Fixed + Tick Pipeline Complete

- **Worker `/backtest` defaults** updated from 15/95 ‚Üí **10.25/82.25** (commands.ts)
- Tick data pipeline complete: 250 trading days (2025-02-18 ‚Üí 2026-02-13) in R2 as Parquet files
- Tick-mode backtest works: `--trailmode tick --date YYYY-MM-DD` loads ticks from R2 for precise intrabar resolution
- Full 2Y backtest at 10.25/82.25 confirms **PF 1.32 raw** (+1027pt, 366 trades, 57 winners)
- Feb 12 tick confirmation: TP hit at 11:05 AM, exact +82.25pt fill
